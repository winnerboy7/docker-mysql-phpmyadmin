# =============================================================================
# # ไฟล์ my.cnf สำหรับ MySQL 8.x

# Spec: 32GB RAM, 16 Cores CPU
# Workload: General Purpose / OLTP (เน้น InnoDB)

# คำเตือน:
# 1. นี่คือ "จุดเริ่มต้น" ที่เน้นประสิทธิภาพ (Aggressive Start)
# 2. ควรทดสอบบน Staging Server ก่อนนำไปใช้บน Production
# 3. ควร Backup ไฟล์ my.cnf เดิมของคุณก่อน
# 4. ตำแหน่งไฟล์นี้มักอยู่ที่: /etc/mysql/my.cnf หรือ /etc/my.cnf ฟล์นี้มักอยู่ที่: /etc/mysql/my.cnf หรือ /etc/my.cnf
# 5. ปรับแต่งเพิ่มเติมตาม Workload และ Hardware ของคุณ

# ตั้งค่าโดย Chaimongkol Khamkom (ToMDev)
# FB: https://facebook.com/winnerboy7
# Email: winnerboy7-At-gmail-Dot-com

# =============================================================================

[mysqld]

# --- General Server Settings ---

user                                = mysql
default-storage-engine              = InnoDB
character-set-server                = utf8mb4
collation-server                    = utf8mb4_unicode_ci

# SQL Mode Settings
sql_mode                            = ""
# sql-mode                            = "STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION"

# ตำแหน่งไฟล์ (อาจต้องปรับตาม OS ของคุณ)

basedir                             = /usr
datadir                             = /var/lib/mysql
socket                              = /var/run/mysqld/mysqld.sock
pid-file                            = /var/run/mysqld/mysqld.pid

# --- Network & Connection Handling ---
# 16 Cores สามารถรองรับ Connection ได้มาก

max_connections                     = 512
max_allowed_packet                  = 256M

# --- Table & Thread Caches (สำหรับ 16 Cores) ---
# ให้มี thread รอตอบสนอง = 2 เท่าของ Cores

thread_cache_size                   = 32
table_open_cache                    = 4096
table_definition_cache              = 2048
open_files_limit                    = 65535

# --- In-Memory Tables ---
# ใช้ RAM มากขึ้นสำหรับ temp tables เพื่อเลี่ยงการเขียนลง Disk

tmp_table_size                      = 256M
max_heap_table_size                 = 256M

# --- InnoDB Settings (ส่วนที่สำคัญที่สุด) ---
# ** หัวใจหลัก: ใช้ RAM 70% (ประมาณ 22GB) สำหรับ Buffer Pool **
# Buffer Pool ใช้เก็บทั้ง Data และ Index ใน RAM

innodb_buffer_pool_size             = 22G

# แบ่ง Buffer Pool เป็น 16 ส่วน (เท่าจำนวน Cores) เพื่อลดการแย่งชิง (Contention)

innodb_buffer_pool_instances        = 16

# บันทึกและโหลดสถานะ Buffer Pool เพื่อให้ Restart ได้เร็วขึ้น

innodb_buffer_pool_dump_at_shutdown = 1
innodb_buffer_pool_load_at_startup  = 1

# --- InnoDB I/O Settings (สำหรับ Cloud/SSD) ---
# ตั้งค่าให้ InnoDB รู้ว่าเราใช้ Disk เร็ว (SSD/NVMe)

innodb_io_capacity                  = 2000
innodb_io_capacity_max              = 4000
innodb_flush_method                 = O_DIRECT

# เพิ่ม Thread สำหรับอ่าน/เขียน (จาก default 4)

innodb_read_io_threads              = 8
innodb_write_io_threads             = 8

# ปล่อยให้ InnoDB จัดการ Concurrency อัตโนมัติ (ดีที่สุดสำหรับ 8.x)

innodb_thread_concurrency           = 0

# --- Transaction Log (Redo Log) ---
# ใช้ Redo log ขนาดใหญ่ (2G) เพื่อเพิ่มประสิทธิภาพการเขียน

innodb_log_file_size                = 1G
innodb_log_files_in_group           = 2

# ** การตั้งค่าเพื่อ Performance (แลกกับความเสี่ยง) **
# 1 = ปลอดภัยสูงสุด (ACID), ช้าลง
# 2 = เร็วขึ้นมาก (Log ถูกเขียนทุก 1 วินาที)
# (หาก OS ล่ม อาจเสียข้อมูลที่ยังไม่ Commit 1-2 วินาที)

innodb_flush_log_at_trx_commit      = 2

# --- File & Caches ---

innodb_file_per_table               = 1
innodb_lru_scan_depth               = 256

# --- Logging (สำคัญมากสำหรับ Production) ---

log_error                           = /var/log/mysql/error.log
log_error_verbosity                 = 2

# --- Slow Query Log (จำเป็นสำหรับการหาคอขวด) ---

slow_query_log                      = 1
slow_query_log_file                 = /var/log/mysql/slow-query.log

# Log query ที่ช้ากว่า 1 วินาที

long_query_time                     = 1

# Log query ที่ไม่ได้ใช้ Index (ช่วยหา Query ที่ไม่ดี)

log_queries_not_using_indexes       = 1

# --- Binary Log (เปิดใช้งานหากต้องการ Replication หรือ Point-in-Time Recovery) ---

server-id                           = 1
log_bin                             = /var/log/mysql/mysql-bin.log
binlog_format                       = ROW
binlog_expire_logs_seconds          = 604800  # 7 วัน
sync_binlog                         = 1       # ปลอดภัยสูงสุดสำหรับ binlog

# --- MySQL 8.4 Settings ---
# (Query Cache ถูกลบออกไปแล้วใน 8.0 ไม่ต้องใส่)
# (innodb_redo_log_capacity คือค่าใหม่ แต่การตั้งค่าข้างบนยังใช้ได้)

default_authentication_plugin       = caching_sha2_password